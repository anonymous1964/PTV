#include<reg52.h>
#define uchar unsigned char
#define uint unsigned int 
sbit led1g=P1^0;				//乘务员铺1
sbit led1b=P1^1;
sbit led1r=P1^2;
sbit led2g=P1^3;				 //乘务员铺2
sbit led2b=P1^4;
sbit led2r=P1^5;
sbit led3g=P1^6;				 //乘务员铺3
sbit led3b=P1^7;
sbit led3r=P0^7;
sbit fengmingqi1=P0^0;			  //乘客蜂鸣器1
sbit fengmingqi2=P0^1;			  //乘客蜂鸣器2
sbit fengmingqi3=P0^2;			  //乘客蜂鸣器3
sbit beep=P3^6;	         		//蜂鸣器测试对射传感器 
sbit juli=P3^2;		    		 //对射红外传感器
sbit chengke1=P3^5;				//乘客1到达的车站?
sbit chengke2=P3^6;			    //乘客2到达的车站?
sbit chengke3=P3^7;			    //乘客3到达的车站?
uchar num=0;						     //距离车站公里数
uchar chezhan=1;					//距离哪个车站
uchar distance1;					//乘客1设置的提醒距离
uchar distance2;					//乘客2设置的提醒距离
uchar distance3;				   //乘客3设置的提醒 距离
uchar final1;					   //计算所得乘客1该提醒地点
uchar final2;					   //计算所得乘客2该提醒地点
uchar final3;					   //计算所得乘客3该提醒地点
void delayms(uchar xms)
{
	uchar i,j;
	for(i=xms;i>0;i--)
		for(j=110;j>0;j--);
}
void cejumokuai()				 //小车行驶到哪个车站 
{
	if(juli==1)
		{   
			num++;
			beep=0;
			delayms(50);
			beep=1;
		}	
}
void daozhanjisuan()		//乘客提醒地点计算
{
	 //乘客1该提醒地点
	if(chengke1==0)		     
	{
		final1=0+distance1;
	}
	if(chengke1==1)
	{
		final1=3+distance1;
	}
	//乘客2该提醒地点
	if(chengke2==0)
	{
		final2=0+distance2;
	}
	if(chengke2==1)
	{
		final2=3+distance2;
	}
	//乘客3该提醒地点
	if(chengke3==0)
	{
		final3=0+distance3;
	}
	if(chengke3==1)
	{
		final3=3+distance3;
	}
}
void afengmingqi1()	      //乘客蜂鸣器1响
{
	 	fengmingqi1=0;
		delayms(500);
		fengmingqi1=1;
		delayms(500);
}
void afengmingqi2()	      //乘客蜂鸣器2响
{
	 	fengmingqi2=0;
		delayms(500);
		fengmingqi2=1;
		delayms(500);
}
void afengmingqi3()	      //乘客蜂鸣器3响
{
	 	fengmingqi3=0;
		delayms(500);
		fengmingqi3=1;
		delayms(500);
}
void aled1r()		    //led1红色
{
	led1g=1;
	led1b=1;
	led1r=0;
}
void aled1g()   		//led1绿色
{
	led1g=0;
	led1b=1;
	led1r=1;
}
void aled1y()   		//led1黄色
{
	led1g=0;
	led1b=1;
	led1r=0;
}
void aled1()			 //led1灭灯
{
	led1g=1;
	led1b=1;
	led1r=1;	
}
void aled2r()		    //led2红色
{
	led2g=1;
	led2b=1;
	led2r=0;
}
void aled2g()   		//led2绿色
{
	led2g=0;
	led2b=1;
	led2r=1;
}
void aled2y()   		//led2黄色
{
	led2g=0;
	led2b=1;
	led2r=0;
}
void aled2()			 //led2灭灯
{
	led2g=1;
	led2b=1;
	led2r=1;	
}
void aled3r()		    //led3红色
{
	led3g=1;
	led3b=1;
	led3r=0;
}
void aled3g()   		//led3绿色
{
	led3g=0;
	led3b=1;
	led3r=1;
}
void aled3y()   		//led3黄色
{
	led3g=0;
	led3b=1;
	led3r=0;
}
void aled3()			 //led3灭灯
{
	led3g=1;
	led3b=1;
	led3r=1;	
}
void matrixkeyscan()		 //键盘
{
	uchar temp,key;
	P2=0xfe;		   //第一行
	temp=P2;
	temp=temp&0xf0;
	if(temp!=0xf0)
	{
		delayms(10);
		temp=P2;
		temp=temp&0xf0;
		if(temp!=0xf0)
		{
			temp=P2;
			switch(temp)
			{
				case 0xee:distance1=1;break;	   //1.1设置提醒距离
				case 0xde:distance1=2;break;	   //1.2设置提醒距离
				case 0xbe:distance1=3;break;	   //1.3设置提醒距离
				case 0x7e:distance1=-1;break;	   //1.4关闭蜂鸣器
			}
			while(temp!=0xf0)
			{
				temp=P2;
				temp=temp&0xf0;
			}
			if(distance1==-1)
			{
				fengmingqi1=1;  				//关闭蜂鸣器1
				final1=0;
				aled1();					   //关闭乘客1灯
			}
		}
	}
	P2=0xfd;	   //第二行
	temp=P2;
	temp=temp&0xf0;
	if(temp!=0xf0)
	{
		delayms(10);
		temp=P2;
		temp=temp&0xf0;
		if(temp!=0xf0)
		{
			temp=P2;
			switch(temp)
			{
				case 0xed:distance2=1;break;		//2.1设置提醒距离
				case 0xdd:distance2=2;break;	    //2.2设置提醒距离
				case 0xbd:distance2=3;break;	    //2.3设置提醒距离
				case 0x7d:distance2=-1;break;		//2.4关闭蜂鸣器
			}
			while(temp!=0xf0)
			{
				temp=P2;
				temp=temp&0xf0;
			}
			if(distance2==-1)
			{
				fengmingqi2=1;	    					//关闭蜂鸣器2
				final2=0;
				aled2();								//关闭乘客2灯
			}

		}
	}
	P2=0xfb;				 //第三行
	temp=P2;
	temp=temp&0xf0;
	if(temp!=0xf0)
	{
		delayms(10);
		temp=P2;
		temp=temp&0xf0;
		if(temp!=0xf0)
		{
			temp=P2;
			switch(temp)
			{
				case 0xeb:distance3=1;break;		     //3.1设置提醒距离
				case 0xdb:distance3=2;break;		     //3.2设置提醒距离
				case 0xbb:distance3=3;break;		     //3.3设置提醒距离
				case 0x7b:distance3=-1;break;			//3.4关闭蜂鸣器
			}
			while(temp!=0xf0)
			{
				temp=P2;
				temp=temp&0xf0;
			}
			if(distance3==-1)
			{
				fengmingqi3=1;	    						//关闭蜂鸣器3
				final3=0;
				aled3();								   	//关闭乘客3灯
			}
		}
	}
}
void daozhantixing()			   //乘客和乘务员提醒
{
	if(final1!=0)
	{
	if(final1==num)
	{
		afengmingqi1();
		aled1y();

	}
	}
	if(final2!=0)
	{
	if(final2==num)
	{
		afengmingqi2();
		aled2y();
	
	}
	}
	if(final3!=0)
	{
	if(final3==num)
	{
		afengmingqi3();
		aled3y();
	}
	}
}
void main()
{	
	while(1)
	{
		cejumokuai();	
	  matrixkeyscan();
	  daozhanjisuan();
	  daozhantixing();


	}
}
